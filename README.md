# Croatian Fiscalization System - Technical Documentation

This directory contains comprehensive technical documentation extracted from the official Croatian Government technical specification (Fiskalizacija - Tehniƒçka specifikacija za korisnike v2.6).

---

## üìö Documentation Structure

```
technical-specification/
‚îú‚îÄ‚îÄ README.md                              # This file
‚îú‚îÄ‚îÄ docs/                                  # Documentation files
‚îÇ   ‚îú‚îÄ‚îÄ 00-document-overview.md            # Document statistics and structure
‚îÇ   ‚îú‚îÄ‚îÄ 01-02-introduction-and-solution.md # System overview and architecture
‚îÇ   ‚îú‚îÄ‚îÄ 03-registration-authentication.md  # FINA system and certificates
‚îÇ   ‚îú‚îÄ‚îÄ 04-electronic-signature.md         # XML signature implementation
‚îÇ   ‚îú‚îÄ‚îÄ 05-services-overview.md            # All CIS services overview
‚îÇ   ‚îú‚îÄ‚îÄ 06-11-services-detailed.md         # Detailed service documentation
‚îÇ   ‚îú‚îÄ‚îÄ 12-message-examples.md             # Complete XML message examples
‚îÇ   ‚îî‚îÄ‚îÄ diagrams/                          # Mermaid flow diagrams
‚îÇ       ‚îú‚îÄ‚îÄ flow-authentication.mermaid
‚îÇ       ‚îú‚îÄ‚îÄ flow-certificate-chain.mermaid
‚îÇ       ‚îú‚îÄ‚îÄ flow-certificate-validation.mermaid
‚îÇ       ‚îú‚îÄ‚îÄ flow-fiskalizacija-racuna.mermaid
‚îÇ       ‚îú‚îÄ‚îÄ flow-promjena-placanja.mermaid
‚îÇ       ‚îú‚îÄ‚îÄ flow-response-structure.mermaid
‚îÇ       ‚îú‚îÄ‚îÄ flow-signature-creation.mermaid
‚îÇ       ‚îú‚îÄ‚îÄ flow-signature-soap.mermaid
‚îÇ       ‚îî‚îÄ‚îÄ flow-signature-verification.mermaid
‚îî‚îÄ‚îÄ code-examples/                         # 57 XML examples from Chapter 9
    ‚îú‚îÄ‚îÄ racun-*.xml                        # Invoice examples (9.1-9.6, 9.31-9.37, 9.38-9.41)
    ‚îú‚îÄ‚îÄ promjena-nacina-placanja-*.xml      # Payment change examples (9.7-9.14)
    ‚îú‚îÄ‚îÄ prodaja-samoposluzni-*.xml         # Self-service examples (9.15-9.20)
    ‚îú‚îÄ‚îÄ napojnica-*.xml                    # Tip/gratuity examples (9.21-9.28)
    ‚îú‚îÄ‚îÄ echo-metoda-*.xml                  # Echo method examples (9.29-9.30)
    ‚îî‚îÄ‚îÄ radnog-vremena-*.xml               # Working hours examples (9.42-9.57)
```

---

## üéØ Quick Start

### 1. Understand the System
Start with [Document Overview](docs/00-document-overview.md) to understand the scope and structure.

### 2. Learn the Architecture
Read [Introduction and Solution Description](docs/01-02-introduction-and-solution.md) to understand:
- How fiscalization works
- ZKI and JIR concepts
- System architecture
- Time synchronization requirements

### 3. Certificate Management
See [Registration and Authentication](docs/03-registration-authentication.md) for:
- FINA system registration
- Certificate requirements
- Certificate loading and validation

### 4. Digital Signatures
[Electronic Signature](docs/04-electronic-signature.md) covers:
- XML Signature standard
- Signature creation process
- Signature validation
- Certificate chain verification

### 5. CIS Services
[Services Overview](docs/05-services-overview.md) lists all available services, then:
- [Services Detailed (5.1-5.6)](docs/06-11-services-detailed.md) for implementation details
- [Message Examples](docs/12-message-examples.md) for ready-to-use templates

---

## üîë Key Concepts

### JIR (Jedinstveni Identifikator Raƒçuna)
- **Unique Invoice Identifier** generated by CIS
- 34-character alphanumeric string
- Must be printed on every fiscalized invoice
- Retrieved after successful fiscalization

### ZKI (Za≈°titni Kod Izdavatelja)
- **Security Code Issuer** generated locally
- 32-character hexadecimal string
- Must be calculated BEFORE issuing invoice
- Based on: certificate + OIB + datetime + invoice data

### CIS (Centralni Informacijski Sustav)
- **Central Information System** operated by Croatian Tax Authority
- Handles all fiscalization requests
- Production: `https://cis.porezna-uprava.hr:8449/FiskalizacijaService`
- Test: `https://cistest.apis-it.hr:8449/FiskalizacijaServiceTest`

### FINA
- **Financial Agency (Financijska agencija)** system
- Handles user registration and certificate issuance
- URL: `https://cis.porezna-uprava.hr`

---

## üìñ Documentation Files

### Overview Files

| File | Description |
|------|-------------|
| [00-document-overview.md](docs/00-document-overview.md) | Statistics, structure, and inventory of the specification |
| [01-02-introduction-and-solution.md](docs/01-02-introduction-and-solution.md) | System architecture, fiscalization workflow, requirements |
| [03-registration-authentication.md](docs/03-registration-authentication.md) | FINA registration, certificate management, authentication |
| [04-electronic-signature.md](docs/04-electronic-signature.md) | XML Signature standard, signing process, validation |

### Service Documentation

| File | Services Covered |
|------|------------------|
| [05-services-overview.md](docs/05-services-overview.md) | All services overview, common structures |
| [06-11-services-detailed.md](docs/06-11-services-detailed.md) | Detailed documentation for services 5.1-5.6 |
| [12-message-examples.md](docs/12-message-examples.md) | Complete XML request/response examples |

### Services Available

1. **Poslovni prostor** (Business Space) - Register business locations
2. **Fiskalizacija raƒçuna** (Invoice Fiscalization) - Submit invoices, get JIR
3. **Promjena naƒçina plaƒáanja** (Payment Change) - Update payment methods
4. **Fiskalizacija ISSN** (ISSN) - ISSN-specific fiscalization
5. **Izvje≈°ƒáe o izdanom raƒçunu** (Invoice Report) - Generate PD/PO reports
6. **Provjera radnog vremena** (Working Hours) - Report/retrieve working hours

---

## üé® Flow Diagrams

All diagrams are in [Mermaid](https://mermaid.js.org/) format and can be viewed in:
- GitHub/GitLab (native support)
- VS Code (with Mermaid extension)
- Online editors: mermaid.live, mermaid-edit.github.io

### Available Diagrams

| Diagram | Description |
|---------|-------------|
| [flow-authentication.mermaid](docs/diagrams/flow-authentication.mermaid) | FINA registration and authentication |
| [flow-certificate-chain.mermaid](docs/diagrams/flow-certificate-chain.mermaid) | Certificate chain validation |
| [flow-certificate-validation.mermaid](docs/diagrams/flow-certificate-validation.mermaid) | Certificate validation checks |
| [flow-fiskalizacija-racuna.mermaid](docs/diagrams/flow-fiskalizacija-racuna.mermaid) | Invoice fiscalization process |
| [flow-promjena-placanja.mermaid](docs/diagrams/flow-promjena-placanja.mermaid) | Payment method change process |
| [flow-response-structure.mermaid](docs/diagrams/flow-response-structure.mermaid) | Response handling and error codes |
| [flow-signature-creation.mermaid](docs/diagrams/flow-signature-creation.mermaid) | Digital signature creation |
| [flow-signature-soap.mermaid](docs/diagrams/flow-signature-soap.mermaid) | Signature placement in SOAP |
| [flow-signature-verification.mermaid](docs/diagrams/flow-signature-verification.mermaid) | Signature verification process |

---

## üíª Code Examples

XML examples are located in [`code-examples/`](code-examples/).

**57 complete XML examples** transcribed from the official specification (Chapter 9, examples 9.1-9.57):

### Example Categories

| Category | Examples | Files |
|----------|----------|-------|
| **Invoice (Racun)** | 9.1-9.6, 9.31-9.37, 9.38-9.41 | `racun-*.xml` |
| **Payment Change (Promjena naƒçina plaƒáanja)** | 9.7-9.14 | `promjena-nacina-placanja-*.xml` |
| **Self-Service (Prodaja samoposlu≈ænih ureƒëaja)** | 9.15-9.20 | `prodaja-samoposluzni-*.xml` |
| **Tip/Gratuity (Napojnica)** | 9.21-9.28 | `napojnica-*.xml` |
| **Echo Method** | 9.29-9.30 | `echo-metoda-*.xml` |
| **Working Hours (Radno vrijeme)** | 9.42-9.57 | `dohvat-radnog-vremena-*.xml`, `brisanje-radnog-vremena-*.xml`, `prijava-radnog-vremena-*.xml`, `prijava-radnih-vremena-liste-poslovnih-*.xml` |

These examples are **production-ready templates** that can be adapted for your implementation. Each file contains complete SOAP envelopes with proper structure, signatures, and example data.

For detailed documentation of each example, see [Message Examples](docs/12-message-examples.md).

---

## üîß Implementation Guide

### Step 1: Certificate Setup
1. Register in FINA system
2. Obtain digital certificate from FINA
3. Install certificate in Windows Certificate Store or save as PFX

### Step 2: Time Synchronization
1. Configure NTP on all systems
2. Verify time sync with CIS (¬±2 seconds tolerance)
3. Monitor time drift regularly

### Step 3: Development
1. Use test environment for development
2. Implement ZKI generation (local)
3. Implement XML signature creation
4. Implement SOAP communication

### Step 4: Testing
1. Test all services with test certificate
2. Verify error handling
3. Test time sync failures
4. Test certificate expiration scenarios

### Step 5: Production Deployment
1. Obtain production certificate
2. Switch to production CIS URL
3. Monitor first transactions
4. Set up alerting

---

## ‚ö†Ô∏è Critical Requirements

### Time Synchronization
- **Maximum drift:** ¬±2 seconds from CIS
- **Required:** NTP synchronization
- **Format:** ISO 8601 with timezone offset

### Certificate Requirements
- **Format:** X.509 issued by FINA
- **Key size:** Minimum 2048 bits (RSA)
- **Subject CN:** Must contain taxpayer OIB
- **Valid:** Not expired, not revoked

### Signature Requirements
- **Standard:** W3C XML Signature (xmldsig-core)
- **Algorithm:** RSAwithSHA1 or RSAwithSHA256
- **Canonicalization:** Exclusive XML Canonicalization
- **Coverage:** Entire request body except SignatureXml

---

## üö® Common Errors

| Error Code | Description | Solution |
|------------|-------------|----------|
| 13 | Validation error | Check data format, required fields |
| 14 | Signature error | Verify certificate, signature process |
| 176 | Invalid OIB | Check OIB format (11 digits), match with certificate |
| 178 | Time difference > 2s | Sync system time with NTP |
| 183 | Duplicate invoice | Invoice already fiscalized |

---

## üîó Related Resources

### Official Resources
- **CIS Production:** https://cis.porezna-uprava.hr:8449/FiskalizacijaService
- **CIS Test:** https://cistest.apis-it.hr:8449/FiskalizacijaServiceTest
- **FINA:** https://cis.porezna-uprava.hr
- **FINA Website:** https://www.fina.hr

### Standards
- **W3C XML Signature:** https://www.w3.org/TR/xmldsig-core/
- **XML Schema:** FiskalizacijaSchema v1.3
- **SOAP 1.1:** https://www.w3.org/TR/2000/NOTE-SOAP-20000508/

### Implementation Files

The implementation of these CIS services varies by programming language. Common components include:

- **Main API client** - Handles all service operations (invoice fiscalization, business space, etc.)
- **CIS communication layer** - SOAP/HTTPS communication with fiscalization server
- **Digital signature module** - XML signature creation and validation
- **ZKI calculation utility** - Security code generation algorithm
- **Schema type definitions** - Auto-generated classes from XSD schema

**Language Examples:**
- C#: Use `System.Security.Cryptography.Xml`
- Java: Use Apache XML Security
- Python: Use `xmlsec` or `lxml`
- PHP: Use `xmlseclibs`

See your programming language's XML security libraries for implementation details.

---

## üìù Document Version

| Field | Value |
|-------|-------|
| **Source** | Fiskalizacija - Tehniƒçka specifikacija za korisnike |
| **Version** | 2.6 |
| **Date** | December 8, 2025 |
| **Pages** | 177 |
| **Language** | Croatian |
| **Extraction Date** | 2025 |

---

## üìß Support

For implementation issues:
- Review the technical specification chapters above
- Check the official CIS documentation
- Consult language-specific XML security libraries
- Test with the CIS test environment first

For official Croatian Tax Authority support:
- CIS Helpdesk (contact via PU portal)
- FINA certificate support

---

## ü§ñ AI Context

This documentation was extracted to provide AI assistants (Claude, Copilot, etc.) with comprehensive context about the Croatian fiscalization system for:
- Code generation assistance
- Bug investigation
- Feature implementation
- Architecture decisions

**For best results when asking AI questions:**
1. Reference specific documentation files
2. Include relevant error messages
3. Share code snippets from the implementation
4. Mention which service you're working with

---

## ‚öñÔ∏è Legal Disclaimer

**IMPORTANT:** This documentation is a machine-translated conversion of the official Croatian government specification and is **NOT an official publication**.

- **Original Author:** POREZNA UPRAVA REPUBLIKE HRVATSKE (Croatian Tax Administration)
- **This repository author** has **NO relation** with the Croatian Government or Tax Authority
- May contain translation or conversion errors
- **Always verify against the official specification** for implementation

**For the complete disclaimer, license terms, and usage guidelines, see [LICENSE.md](LICENSE.md).**

---

*Last updated: 2025 (extracted from v2.6 specification dated 2025-12-08)*
